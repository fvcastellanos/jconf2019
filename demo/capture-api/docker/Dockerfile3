FROM alpine:edge

ENV REQUEST_LIMIT=100kb APP_ID=capture-api LOG_LEVEL=info NODE_ENV=prod PORT=9080 SWAGGER_API_SPEC=/capture/v1/spec

# ENV REQUEST_LIMIT=100kb
# ENV APP_ID=capture-api
# ENV LOG_LEVEL=info
# ENV NODE_ENV=production
# ENV PORT=9080
# ENV SWAGGER_API_SPEC=/capture/v1/spec

# Tell Puppeteer to skip installing Chrome. We'll be using the installed package.
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD true

# Installs latest Chromium (77) package.
RUN apk add --no-cache \
      chromium \
      nss \
      freetype \
      freetype-dev \
      harfbuzz \
      ca-certificates \
      ttf-freefont \
      nodejs \
      npm \
      yarn 

# Puppeteer v1.19.0 works with Chromium 77.
RUN yarn add puppeteer@1.19.0

# Create app directory
WORKDIR /opt/cavitos/capture-api

# Install app dependencies
COPY package*.json ./

# Building code for production
RUN npm ci --only=production

# Bundle app source
COPY . .

RUN npm install && npm run-script compile

# Add user so we don't need --no-sandbox.
RUN addgroup -S capture && adduser -S -g capture capture \
    && mkdir -p /home/capture/Downloads /opt/cavitos/capture-api \
    && chown -R capture:capture /home/capture \
    && chown -R capture:capture /opt/cavitos/capture-api

# Run everything after as non-privileged user.
USER capture

EXPOSE ${PORT}
CMD [ "npm", "start" ]
